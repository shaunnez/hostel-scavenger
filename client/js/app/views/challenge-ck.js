define(function(e){"use strict";var t=e("jquery"),n=e("utils/globals"),r=e("underscore"),i=e("backbone"),s=e("views/base"),o=e("text!tpl/challenge.html"),u=r.template(o);return s.extend({events:{},initialize:function(e){this.events=r.extend({},s.prototype.events,this.events);this.hunt=e.hunt;this.challengeId=e.challengeId;this.user=e.user;this.leader=e.leader;this.challenges=this.hunt.get("challenges");this.challenge=this.getChallenge(e.challengeId,this.challenges);this.currentWaypointLatLng=new google.maps.LatLng(this.challenge.latitude,this.challenge.longitude);this.render()},render:function(){this.$el.html(u({challenge:this.challenge}));this.$optionsContainer=this.$el.find("#options");this.$inlineFile=this.$el.find(".inline-file");this.$canvas=this.$el.find("#challenge-canvas");this.ctx=this.$canvas[0].getContext("2d");return this},postRender:function(){this.listenTo(this.user,"change",this.renderValidate);var e=this,t=this.challenge.image?this.challenge.image.medium.url:this.getStaticMapUrl(),n=new Image;n.onload=function(){e.$optionsContainer.removeClass("loader").html(n);e.renderValidate()};n.src=t;this.updateMyLatLong()},onClose:function(){this.stopListening(this.user,"change",this.renderValidate);this.$el.find("#challengeImagePicker").off("click");this.$el.find("#challengeImagePicker").off("change");clearTimeout(this.timeout)},updateMyLatLong:function(){var e=this;this.getPosition(function(t){e.myLatLng=new google.maps.LatLng(t.coords.latitude,t.coords.longitude);clearTimeout(e.timeout);e.timeout=setTimeout(function(){e.updateMyLatLong()},3e4)})},renderValidate:function(){var e=this,t=this.user.challenges(),n=this.getChallenge(this.challengeId,t),r=n&&n.state!=undefined?n.state:"incomplete";if(r=="incomplete"){var i='<input id="challengeImagePicker" type="file" class="file" accept="image/*;capture=camera" capture="camera"  /> <span class="btn btn-success btn-info btn-block">VALIDATE</span>';this.$inlineFile.html(i);this.$el.find("#challengeImagePicker").on("click",function(t){e.checkPosition(t)});this.$el.find("#challengeImagePicker").on("change",function(t){e.uploadChallenge(t)})}else{this.$el.find("#challengeImagePicker").remove().off("change").off("click");this.$inlineFile.find(".btn").removeClass("btn-info").text("VALIDATED")}},getChallenge:function(e,t){var n={};for(var r=0,i=t.length;r<i;r++)if(t[r].id.toString()==e.toString()){n=t[r];break}return n},getStaticMapUrl:function(){var e=this.$optionsContainer.height(),t=this.$optionsContainer.width();e==0&&(e=320);t==0&&(t=320);var n="http://maps.googleapis.com/maps/api/staticmap?sensor=true&scale=2&zoom=13";n+="&size="+t+"x"+e;n+="&center="+this.challenge.latitude+","+this.challenge.longitude;n+="&markers=color:red%7Ccolor:red%7Clabel:C%7C"+this.challenge.latitude+","+this.challenge.longitude;return n},checkPosition:function(e){var t=this.distanceBetweenTwoPoints(this.myLatLng,this.currentWaypointLatLng);if(this.challenge.gpsRange>t)return!0;n.notification("error","You are not close enough to the waypoint!");e.preventDefault();return!1},uploadChallenge:function(e){var t=this,i=e.target.files,s=this.$inlineFile;if(i.length>0){var o=i[0],u=new FileReader;u.onload=function(e){var i=e.target.result,s=r.clone(t.challenge);s.state="pending";s.image=t.resizeImageCanvas(i);s.date=n.today();var o=t.leader.points()+s.points,u=r.clone(t.user.challenges());u.push(s);t.user.set({challenges:u});t.leader.set({points:o});t.renderValidate();n.notification("success","Successfully sent photo")};u.readAsDataURL(o)}e.preventDefault();return!1},resizeImageCanvas:function(e){var t=new Image;t.src=e;var n=800,r=600,i=t.width,s=t.height;if(i>s){if(i>n){s*=n/i;i=n}}else if(s>r){i*=r/s;s=r}this.$canvas[0].width=i;this.$canvas[0].height=s;this.ctx.drawImage(t,0,0,i,s);return this.$canvas[0].toDataURL("image/jpeg",.7)},getPosition:function(e){navigator&&navigator.geolocation?navigator.geolocation.getCurrentPosition(function(t){e(t)},function(t){e(!1)}):e(!1)},distanceBetweenTwoPoints:function(e,t){return google.maps.geometry.spherical.computeDistanceBetween(e,t)}})});