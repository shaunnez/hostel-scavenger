define(function(e){"use strict";var t=e("jquery"),n=e("utils/globals"),r=e("underscore"),i=e("backbone"),s=e("views/base"),o=e("text!tpl/profile.html"),u=r.template(o);return s.extend({events:{"change #imagePicker":"uploadAvatar"},initialize:function(e){this.events=r.extend({},s.prototype.events,this.events);this.user=e.user;this.render();this.renderAvatar();this.listenTo(this.user,"sync",this.renderAvatar)},render:function(){this.$el.html(u());this.$uploadBtn=this.$el.find("#btnUpload");this.$imagePicker=this.$el.find("#imagePicker");this.$avatar=this.$el.find("#imgAvatar");this.$canvas=this.$el.find("#profile-canvas");this.ctx=this.$canvas[0].getContext("2d");return this},postRender:function(){},onClose:function(){this.stopListening(this.user)},renderAvatar:function(){if(this.user&&this.user.has("avatar")){this.$avatar.attr("src","");this.$avatar.attr("src",this.user.get("avatar"))}},uploadAvatar:function(e){var t=this,n=event.target.files;if(n.length>0){var r=n[0],i=new FileReader;i.onload=function(e){var n=e.target.result,r=t.resizeImageCanvas(n);t.user.set({avatar:r});t.renderAvatar()};i.readAsDataURL(r)}e.preventDefault();return!1},resizeImageCanvas:function(e){var t=new Image;t.src=e;var n=800,r=600,i=t.width,s=t.height;if(i>s){if(i>n){s*=n/i;i=n}}else if(s>r){i*=r/s;s=r}this.$canvas[0].width=i;this.$canvas[0].height=s;this.ctx.drawImage(t,0,0,i,s);return this.$canvas[0].toDataURL("image/jpeg",.7)}})});