define(function(e){"use strict";var t=e("jquery"),n=e("utils/globals"),r=e("underscore"),i=e("backbone"),s=e("collections/locations"),o=e("models/location"),u=e("views/base"),a=e("text!tpl/map.html"),f=r.template(a);return u.extend({events:{},initialize:function(e){this.events=r.extend({},u.prototype.events,this.events);this.user=e.user;this.hunt=e.hunt;this.challenges=this.hunt.get("challenges");this.locations=new s;this.location=new o({id:this.user.id});this.location.set({email:this.user.get("email"),username:this.user.get("username")});this.markers={};this.challengeMarkers={};this.users={};this.render()},render:function(){this.$el.html(f());this.$mapCanvas=this.$el.find("#map_canvas");this.$userList=this.$el.find("#user-list");return this},postRender:function(){var e=this;this.setupMap();if(this.locations.length>0)for(var t=0,n=this.locations.length;t<n;t++)this.addLocation(this.locations.at(t));this.listenTo(this.locations,"add",this.addLocation);this.listenTo(this.locations,"remove",this.removeLocation);this.listenTo(this.locations,"change",this.updateLocation);this.listenTo(this.user,"all",this.renderChallenges)},onClose:function(){var e=this;n.hideNotificiation();this.map&&this.myMarker&&this.myMarker.setMap(null);this.map&&this.map.Dispose&&this.map.Dispose();r.each(this.locations,function(t){e.removeLocation(t)});this.markers={};this.challengeMarkers={};this.users={};this.myMarker=null;this.map=null;this.bluedot=null;this.location.destroy({success:function(){}});this.location=null;this.watchPosition&&navigator&&navigator.geolocation&&navigator.geolocation.clearWatch(this.watchPosition);this.stopListening(this.locations);this.stopListening(this.user,"all",this.renderChallenges)},setupMap:function(){var e=this;this.map=new google.maps.Map(this.$mapCanvas[0],{zoom:14,mapTypeId:google.maps.MapTypeId.ROADMAP});if(navigator&&navigator.geolocation){navigator.geolocation.getCurrentPosition(function(t){e.displayLocation(t);e.map.setCenter(e.myLatLng);e.renderChallenges()},function(t){e.handleLocationError(t)});if(navigator.userAgent&&(navigator.userAgent.indexOf("iPhone")!==-1||navigator.userAgent.indexOf("Android")!==-1)){var t={enableHighAccuracy:!0,maximumAge:3e4,timeout:27e3};this.watchPosition=navigator.geolocation.watchPosition(function(t){e.displayLocation(t)},function(t){e.handleLocationError(t)},t)}}},handleLocationError:function(e){var t=["We are not quite sure what happened.","Sorry. Permission to find your location has been denied.","Sorry. Your position could not be determined.","Sorry. Timed out."];n.notification("error",t[e.code]);console.log(t[e.code])},displayLocation:function(e){if(e&&this.map&&this.location){this.myLatLng=new google.maps.LatLng(e.coords.latitude,e.coords.longitude);this.location.set({latitude:e.coords.latitude,longitude:e.coords.longitude});this.myMarker?this.myMarker.setPosition(this.myLatLng):this.myMarker=new google.maps.Marker({flat:!0,icon:this.dotMarker("blue"),map:this.map,optimized:!1,position:this.myLatLng,title:"I might be here",visible:!0})}},dotMarker:function(e){return new google.maps.MarkerImage("/img/"+e+"dot_retina.png",null,null,new google.maps.Point(8,8),new google.maps.Size(17,17))},addLocation:function(e){if(e&&this.user.id!==e.id&&this.markers[e.id]==undefined){this.markers[e.id]=new google.maps.Marker({flat:!0,icon:this.dotMarker("red"),map:this.map,optimized:!1,position:new google.maps.LatLng(e.get("latitude"),e.get("longitude")),title:"I might be here",visible:!0});this.users[e.id]={email:e.get("email"),username:e.get("username")}}},removeLocation:function(e){if(e){var n=this.markers[e.id];n&&n.setMap(null);this.markers[e.id]=null;this.users[e.id]=null;t.each(this.challengeMarkers,function(e,t){t.marker.setMap(null);t.circle.setMap(null)})}},updateLocation:function(e){this.user.id!=this.id&&(this.markers[e.id]?this.markers[e.id].setPosition(new google.maps.LatLng(e.get("latitude"),e.get("longitude"))):this.addLocation(e))},renderChallenges:function(){for(var e=0,t=this.challenges.length;e<t;e++){var n=this.challenges[e],r=this.getUserChallenge(n.id),i=new google.maps.LatLng(n.latitude,n.longitude),s=this.challengeMarkers[n.id];if(s){s.marker.setMap(null);s.circle.setMap(null)}var o={strokeColor:"#FF0000",strokeOpacity:.6,strokeWeight:2,fillColor:"#FF0000",fillOpacity:.25,map:this.map,center:i,radius:n.gpsRange};if(r&&r.state&&r.state=="pending"){o.strokeColor="blue";o.fillColor="blue"}else if(r&&r.state&&r.state=="complete"){o.strokeColor="green";o.fillColor="green"}var u=new google.maps.Circle(o),a=new google.maps.Marker({map:this.map,position:i,title:n.id.toString()});google.maps.event.addListener(a,"click",function(e){window.location="#challenges/"+this.title});this.challengeMarkers[n.id]={marker:a,circle:u}}},getUserChallenge:function(e){var t={};this.userChallenges=this.user.challenges();for(var n=0,r=this.userChallenges.length;n<r;n++){var i=this.userChallenges[n];if(i.id==e){console.log("found challenge");t=i;break}}return t}})});