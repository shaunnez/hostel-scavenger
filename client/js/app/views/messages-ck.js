define(function(e){"use strict";var t=e("jquery"),n=e("utils/globals"),r=e("underscore"),i=e("backbone"),s=e("models/message"),o=e("views/base"),u=e("text!tpl/messages.html"),a=e("text!tpl/message.html"),f=r.template(a),l=r.template(u);return o.extend({events:{"focus #txtChatMessage":"scrollBottom","click #btnSend":"sendMessage"},initialize:function(e){this.events=r.extend({},o.prototype.events,this.events);this.user=e.user;this.messages=e.messages;this.render()},render:function(){this.$el.html(l());this.$messages=this.$el.find(".messages-container");this.$txtMessage=this.$el.find("#txtChatMessage");return this},postRender:function(){if(this.messages.length>0)for(var e=0,t=this.messages.length;e<t;e++)this.addMessage(this.messages.at(e));this.listenTo(this.messages,"add",this.addMessage)},onClose:function(){this.stopListening(this.messages)},autoScroll:function(){var e=!1,t=this.$messages.scrollTop(),n=this.$messages.get(0).scrollHeight,r=this.$messages.height(),i=500,s=r>=n-t-i;if(t==0||s)e=!0;return e},addMessage:function(e){this.$messages.append(f({user:this.user,message:e}));this.$messages.stop();this.autoScroll()&&this.scrollBottom()},scrollBottom:function(){this.$messages.scrollTop(this.$messages.get(0).scrollHeight)},sendMessage:function(e){e&&e.preventDefault();if(this.$txtMessage.val()!==""){if(this.$txtMessage.val().length>450){n.notification("error","Please only sent up to 450 characters in your message");return!1}var t=this;this.messages.add(new s({userid:this.user.id,email:this.user.get("email"),username:this.user.get("email"),avatar:this.user.avatar(),body:this.$txtMessage.val()}));this.$txtMessage.val("")}return!1}})});