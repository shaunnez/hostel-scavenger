define(function(e){"use strict";var t=e("jquery"),n=e("utils/globals"),r=e("utils/PageSlider"),i=e("app/baseRouter"),s=e("backbone");return i.extend({container:t("#main-container"),routes:{logout:"logout",login:"login",menu:"menu",challenges:"challenges","challenges/:id":"challenge",tasks:"tasks",leaderboard:"leaderboard",profile:"profile",map:"map",messages:"messages","*actions":"menu"},before:function(e,t){var n=this;if(!!n.auth)return t();n.firebaseLogin(t)},firebaseLogin:function(e){var t=this;t.auth=new FirebaseSimpleLogin(n.connection(),function(r,i){!r&&i?t.loadUser(i,function(){t.loadHunts(function(){return e()})}):r?n.notification("error",r):t.login()})},loadUser:function(t,n){var r=this;e(["models/user","models/leader"],function(e,i){r.user=new e({id:t.id});r.leader=new i({id:t.id});var s={};t.provider=="facebook"?s={uid:t.uid,email:t.email,username:t.username,fbAvatar:"http://graph.facebook.com/"+t.id+"/picture?width=250&height=250"}:t.provider=="twitter"?s={uid:t.uid,email:t.username+"@twitter.com",username:t.username,fbAvatar:t.profile_image_url}:s={uid:t.uid,email:t.email,username:t.email.split("@")[0]};r.user.set(s);r.leader.set({username:s.username});s.fbAvatar&&r.leader.set({fbAvatar:s.fbAvatar});n()})},loadHunts:function(t){var r=this;e(["collections/hunts"],function(e){var i=new e;i.fetch({dataType:"jsonp",success:function(e){r.hunt=i.at(0);r.hunts=e;navigator&&navigator.geolocation?navigator.geolocation.getCurrentPosition(function(e){t()},function(e){n.notification("error","Error geolocation",!1);t()}):t()},error:function(e){n.notification("error","Error fetching scavenger hunts",!1);t(i)}})})},loadView:function(e){var n=this;n.slider||(n.slider=new PageSlider(n.container));this.slider.slidePage(t(e.el),function(){n.currentView&&n.currentView.close()&&n.currentView.remove();n.currentView=e;n.currentView&&n.currentView.postRender()})},logout:function(){var e=this;n.notification("info","Logging out",!0,null,function(){e.auth&&e.auth.logout();e.user=null;e.navigate("#",{trigger:!0,replace:!0})})},login:function(){var t=this;e(["app/views/login"],function(e){console.log("login");t.loadView(new e({auth:t.auth}))})},home:function(){var t=this;e(["app/views/home"],function(e){t.loadView(new e({user:t.user}))})},menu:function(t){var n=this;e(["app/views/menu"],function(e){n.loadView(new e({user:n.user,hunt:n.hunt}))})},challenges:function(){var t=this;e(["app/views/challenges"],function(e){t.loadView(new e({user:t.user,hunt:t.hunt}))})},challenge:function(t){var n=this;e(["app/views/challenge"],function(e){n.loadView(new e({user:n.user,leader:n.leader,hunt:n.hunt,challengeId:t}))})},tasks:function(){var t=this;e(["app/views/tasks"],function(e){t.loadView(new e({user:t.user,leader:t.leader,hunt:t.hunt}))})},leaderboard:function(){var t=this;e(["app/views/leaderboard"],function(e){t.loadView(new e({user:t.user,hunt:t.hunt}))})},profile:function(){var t=this;e(["app/views/profile"],function(e){t.loadView(new e({user:t.user}))})},map:function(){var t=this;e(["app/views/map"],function(e){t.loadView(new e({user:t.user,hunt:t.hunt}))})},messages:function(){var t=this;e(["app/views/messages","collections/messages"],function(e,n){t.chatMessages||(t.chatMessages=new n({limit:50}));t.loadView(new e({user:t.user,messages:t.chatMessages}))})}})});